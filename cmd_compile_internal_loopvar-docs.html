<!DOCTYPE html>
<html lang="en" data-theme="dark">
   <head>
      <meta charset="UTF-8" />
      <meta
         name="viewport"
         content="width=device-width, initial-scale=1.0"
      />
      <title>Docs - loopvar</title>
      <link
         href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css"
         rel="stylesheet"
      />
      <style>
         html {
            font-size: 13px;
         }
         body {
            display: flex;
            min-height: 100vh;
            margin: 0;
         }
         .sidebar {
            width: 200px;
            background: rgba(59, 56, 56, 0.1);
            padding: 1.2rem;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.3);
            overflow-y: auto;
            margin-right: 7px;
         }
         main {
            flex: 0.9;
            padding: 1rem;
            margin: 0;
            max-width: calc(100% - 220px);
         }
         h1 {
            font-size: 1.4rem;
            margin-bottom: 1rem;
         }
         h2 {
            font-size: 1.2rem;
            margin: 0.3rem 0 0.2rem;
         }
         pre {
            background: #1e1e1e;
            color: #dcdcdc;
            padding: 0.4rem 0.6rem;
            border-radius: 6px;
            margin: 0 0 1rem;
            font-size: 0.85rem;
            overflow-x: auto;
         }
         code {
            color: #f0dbdb;
            white-space: pre-wrap;
         }
         p {
            font-size: 15px;
            padding-top: 10px;
         }
         article {
            margin-bottom: 0.5rem;
            padding: 0.4rem 0.9rem;
            background: rgba(59, 56, 56, 0.5);
            border-radius: 10px;
            max-width: 99%;
            box-shadow: 0 0 3px rgba(0, 0, 0, 0.3);
         }
         .hidden {
            display: none;
         }
         .filter-toggle label {
            display: block;
            margin-bottom: 0.5rem;
         }
         .field-line {
            display: block;
         }
      </style>
   </head>
   <body>
      <aside class="sidebar">
         <a href="index.html">⌂</a>
         |
         <a href="#" onclick="history.back()">←</a>
         <hr style="opacity: 0" />
         <h2>Filters</h2>
         <hr />
         <input
            type="search"
            id="searchInput"
            placeholder="Search symbols..."
            style="
               width: 100%;
               margin-bottom: 1rem;
               margin-top: 0.8rem;
               border-radius: 10px !important;
               height: 50px;
               height: 2.5rem;
            "
         />
         <div class="filter-toggle">
            <label>
               <input type="checkbox" id="showPrivateFunctions" />
               Show private functions
            </label>
            <label>
               <input type="checkbox" id="showPrivateStructs" />
               Show private structs
            </label>
            <label>
               <input type="checkbox" id="showPrivateFields" />
               Show private struct fields
            </label>
            <label>
               <input type="checkbox" id="showPrivateGlobals" />
               Show private globals
            </label>
         </div>
         <hr style="opacity: 0" />
         <h2 style="padding-top: 5px">Subpackages</h2>
         <hr />
          
         <a href="cmd_compile_internal_loopvar_testdata-docs.html">testdata</a>
         <br />
          
      </aside>
      <main>
         <h1>
            Package
            <code>loopvar</code>
         </h1>
         <hr />
          
         <article class="struct" data-name="VarAndLoop">
            <h2>type VarAndLoop struct</h2>
            <hr />
            
            <pre
               class="fields-block"
            ><code class="fields-code">Name *ir.Name
Loop ir.Node
LastPos src.XPos</code></pre>
         </article>
          
         <article class="function" data-name="ForCapture">
            <h2>ForCapture</h2>
            <hr />
            
            <p>ForCapture transforms for and range loops that declare variables that might be
captured by a closure or escaped to the heap, using a syntactic check that
conservatively overestimates the loops where capture occurs, but still avoids
transforming the (large) majority of loops. It returns the list of names
subject to this change, that may (once transformed) be heap allocated in the
process. (This allows checking after escape analysis to call out any such
variables, in case it causes allocation/performance problems).

The decision to transform loops is normally encoded in the For/Range loop node
field DistinctVars but is also dependent on base.LoopVarHash, and some values
of base.Debug.LoopVar (which is set per-package).  Decisions encoded in DistinctVars
are preserved across inlining, so if package a calls b.F and loops in b.F are
transformed, then they are always transformed, whether b.F is inlined or not.

Per-package, the debug flag settings that affect this transformer:

base.LoopVarHash != nil => use hash setting to govern transformation.
note that LoopVarHash != nil sets base.Debug.LoopVar to 1 (unless it is >= 11, for testing/debugging).

base.Debug.LoopVar == 11 => transform ALL loops ignoring syntactic/potential escape. Do not log, can be in addition to GOEXPERIMENT.

The effect of GOEXPERIMENT=loopvar is to change the default value (0) of base.Debug.LoopVar to 1 for all packages.</p>
            
            <pre><code>func ForCapture(fn *ir.Func) []VarAndLoop</code></pre>
         </article>
         
         <article class="function" data-name="forAllDefInInitUpdate">
            <h2>forAllDefInInitUpdate</h2>
            <hr />
            
            <p>forAllDefInInitUpdate applies "do" to all the defining assignments in the Init clause of a ForStmt.
This abstracts away some of the boilerplate from the already complex and verbose for-3-clause case.</p>
            
            <pre><code>func forAllDefInInitUpdate(x *ir.ForStmt, do func)</code></pre>
         </article>
         
         <article class="function" data-name="forAllDefInInit">
            <h2>forAllDefInInit</h2>
            <hr />
            
            <p>forAllDefInInit is forAllDefInInitUpdate without the update option.</p>
            
            <pre><code>func forAllDefInInit(x *ir.ForStmt, do func)</code></pre>
         </article>
         
         <article class="function" data-name="rewriteNodes">
            <h2>rewriteNodes</h2>
            <hr />
            
            <p>rewriteNodes applies editNodes to all statement lists in fn.</p>
            
            <pre><code>func rewriteNodes(fn *ir.Func, editNodes func)</code></pre>
         </article>
         
         <article class="function" data-name="LogTransformations">
            <h2>LogTransformations</h2>
            <hr />
            
            <pre><code>func LogTransformations(transformed []VarAndLoop)</code></pre>
         </article>
         
      </main>
      <script>
         function isPrivate(name) {
            return /^[a-z]/.test(name);
         }
         document.addEventListener("DOMContentLoaded", () => {
            const toggles = {
               functions: document.getElementById("showPrivateFunctions"),
               structs: document.getElementById("showPrivateStructs"),
               fields: document.getElementById("showPrivateFields"),
               globals: document.getElementById("showPrivateGlobals"),
            };
            const hideInitial = (selector, toggle) => {
               document.querySelectorAll(selector).forEach((el) => {
                  const name = el.dataset.name;
                  if (isPrivate(name)) {
                     el.classList.add("private", "hidden");
                  }
               });
               toggle.addEventListener("change", () => {
                  const show = toggle.checked;
                  document
                     .querySelectorAll(`${selector}.private`)
                     .forEach((el) => {
                        el.classList.toggle("hidden", !show);
                     });
               });
            };
            hideInitial("article.function", toggles.functions);
            hideInitial("article.struct", toggles.structs);
            hideInitial("article.global", toggles.globals);
            document
               .querySelectorAll("article.struct")
               .forEach((article) => {
                  const codeBlock =
                     article.querySelector("code.fields-code");
                  if (!codeBlock) return;
                  const lines = codeBlock.innerText.split("\n");
                  const newContent = lines
                     .map((line) => {
                        const trimmed = line.trim();
                        const nameMatch = trimmed.match(
                           /^([A-Za-z_][A-Za-z0-9_]*)/
                        );
                        if (!nameMatch)
                           return `<span class=\"field-line\">${line}</span>`;
                        const name = nameMatch[1];
                        const isPriv = isPrivate(name);
                        return `<span class=\"field-line${
                           isPriv ? " hidden private" : ""
                        }\" data-name=\"${name}\">${line}</span>`;
                     })
                     .join("");
                  codeBlock.innerHTML = newContent;
                  toggles.fields.addEventListener("change", () => {
                     const show = toggles.fields.checked;
                     article
                        .querySelectorAll(".field-line.private")
                        .forEach((el) =>
                           el.classList.toggle("hidden", !show)
                        );
                  });
               });
            const searchInput = document.getElementById("searchInput");
            searchInput.addEventListener("input", () => {
               const query = searchInput.value.trim().toLowerCase();
               document.querySelectorAll("article").forEach((el) => {
                  const name = el.dataset.name.toLowerCase();
                  if (query === "" || name.includes(query)) {
                     el.classList.remove("hidden");
                  } else {
                     el.classList.add("hidden");
                  }
               });
            });
         });
      </script>
   </body>
</html>
